{"version":3,"file":"nextcloudpresence-main.mjs","sources":["../src/syncTables.js","../src/App.vue","../src/main.ts"],"sourcesContent":["import axios from '@nextcloud/axios'\nimport { generateUrl } from '@nextcloud/router'\n\nconst ocsHeaders = {\n\t'OCS-APIRequest': 'true',\n\tAccept: 'application/json',\n}\n\nconst NAME_COLUMN_ID = 21\nconst STATE_COLUMN_ID = 22\nconst LAST_CHANGED_COLUMN_ID = 23\n\nfunction ocsData(resp) {\n\treturn resp?.data?.ocs?.data\n}\n\nfunction rowDataArray(row) {\n\treturn row?.data ?? [] // [{ columnId, value }, ...]\n}\n\nfunction getValueByColumnId(row, columnId) {\n\tconst entry = rowDataArray(row).find(x => x.columnId === columnId)\n\treturn entry?.value ?? ''\n}\n\nfunction buildRowPayloadFromPerson(p) {\n\treturn {\n\t\tdata: [\n\t\t\t{ columnId: NAME_COLUMN_ID, value: String(p.name ?? '') },\n\t\t\t{ columnId: STATE_COLUMN_ID, value: p.home ? 'home' : 'away' },\n\t\t\t{ columnId: LAST_CHANGED_COLUMN_ID, value: String(p.last_changed ?? '') },\n\t\t],\n\t}\n}\n\nexport async function syncPresenceToTables({ tableId, persons }) {\n\t// 1) list existing rows in the table\n\tconst listUrl = generateUrl(`/ocs/v2.php/apps/tables/api/2/tables/${tableId}/rows`)\n\tconst listResp = await axios.get(listUrl, { headers: ocsHeaders })\n\tconst rows = ocsData(listResp) ?? []\n\n\t// 2) map rows by \"name\"\n\tconst existingByName = new Map()\n\tfor (const row of rows) {\n\t\tconst name = getValueByColumnId(row, NAME_COLUMN_ID)\n\t\tif (name) existingByName.set(name, row)\n\t}\n\n\t// 3) upsert each person\n\tfor (const p of persons) {\n\t\tconst payload = buildRowPayloadFromPerson(p)\n\t\tconst existing = existingByName.get(p.name)\n\n\t\tif (existing?.id) {\n\t\t\t// Update row (this is the first endpoint to try for Tables API v2)\n\t\t\tconst updateUrl = generateUrl(`/ocs/v2.php/apps/tables/api/2/rows/${existing.id}`)\n\t\t\tawait axios.put(updateUrl, payload, { headers: ocsHeaders })\n\t\t} else {\n\t\t\t// Create row\n\t\t\tconst createUrl = generateUrl(`/ocs/v2.php/apps/tables/api/2/tables/${tableId}/rows`)\n\t\t\tawait axios.post(createUrl, payload, { headers: ocsHeaders })\n\t\t}\n\t}\n}\n","<script setup>\nimport { ref, onMounted } from 'vue'\nimport axios from '@nextcloud/axios'\nimport { generateUrl } from '@nextcloud/router'\nimport { syncPresenceToTables } from './syncTables.js'\n\nconst persons = ref([])\nconst syncing = ref(false)\nconst syncError = ref('')\nconst syncOk = ref('')\n\nconst tableId = ref(0)\n\nasync function loadPresence() {\n\tconst response = await axios.get(generateUrl('/ocs/v2.php/apps/nextcloudpresence/api/v1/presence'))\n\tconst data = response.data.ocs?.data || response.data\n\tpersons.value = data\n}\n\nasync function loadSettings() {\n\ttry {\n\t\tconst response = await axios.get(generateUrl('/ocs/v2.php/apps/nextcloudpresence/settings'))\n\t\tconst data = response.data.ocs?.data || response.data\n\t\ttableId.value = parseInt(data.tables_table_id, 10) || 0\n\t} catch (e) {\n\t\ttableId.value = 0\n\t}\n}\n\nasync function syncToTables() {\n\tsyncing.value = true\n\tsyncError.value = ''\n\tsyncOk.value = ''\n\ttry {\n\t\tawait syncPresenceToTables({ tableId: tableId.value, persons: persons.value })\n\t\tsyncOk.value = 'Synced presence to Tables.'\n\t} catch (e) {\n\t\tsyncError.value = e?.response?.data ? JSON.stringify(e.response.data) : (e?.message || String(e))\n\t} finally {\n\t\tsyncing.value = false\n\t}\n}\n\nonMounted(async () => {\n\tawait Promise.all([loadPresence(), loadSettings()])\n})\n</script>\n\n<template>\n\t<div>\n\t\t<button v-if=\"tableId > 0\" :disabled=\"syncing\" @click=\"syncToTables\">\n\t\t\t{{ syncing ? 'Syncingâ€¦' : 'Sync to Nextcloud Tables' }}\n\t\t</button>\n\t\t<p v-if=\"syncOk\">\n\t\t\t{{ syncOk }}\n\t\t</p>\n\t\t<p v-if=\"syncError\" style=\"color:red\">\n\t\t\t{{ syncError }}\n\t\t</p>\n\t</div>\n</template>\n","import { createApp } from 'vue'\nimport App from './App.vue'\n\nconst app = createApp(App)\napp.mount('#nextcloudpresence')\n"],"names":["ocsHeaders","NAME_COLUMN_ID","STATE_COLUMN_ID","LAST_CHANGED_COLUMN_ID","ocsData","resp","rowDataArray","row","getValueByColumnId","columnId","x","buildRowPayloadFromPerson","p","syncPresenceToTables","tableId","persons","listUrl","generateUrl","listResp","axios","rows","existingByName","name","payload","existing","updateUrl","createUrl","ref","syncing","syncError","syncOk","loadPresence","response","data","loadSettings","syncToTables","e","onMounted","_createElementBlock","_hoisted_1","_openBlock","_hoisted_3","_toDisplayString","app","createApp","App"],"mappings":"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"}